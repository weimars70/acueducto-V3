?>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Salidas</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.0/css/tabulator.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.0/js/tabulator.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        /* styles.css */
        .input-derecha {
            text-align: right;
        }

        .container {
            max-width: 1400px;
            margin: 10px auto;
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* --- FORM GRID PRINCIPAL --- */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        /* Porcentajes Bloque CLIENTE */
        .w-40 {
            width: 40%;
        }

        .w-50 {
            width: 50%;
        }

        .w-60 {
            width: 60%;
        }

        .w-15 {
            width: 15%;
        }

        .w-8 {
            width: 8%;
        }

        /* Porcentajes Bloque ITEMS */
        .w-5 {
            width: 5%;
        }

        .w-10 {
            width: 10%;
        }

        .w-11 {
            width: 11%;
        }

        .w-12 {
            width: 12%;
        }

        .w-13 {
            width: 13%;
        }

        .w-20 {
            width: 20%;
        }

        .w-23 {
            width: 23%;
        }

        /* Porcentajes Bloque TOTALES */
        .w-20 {
            width: 20%;
        }

        .totales-container {
            display: flex;
            justify-content: flex-end;
            /* Alinea todo a la derecha */
            gap: 15px;
            /* separaci√≥n entre bloques */
            margin-top: 10px;
        }

        /* Inputs */
        input,
        select,
        button {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background: #2196f3;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background: #1976d2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-add {
            background: #4CAF50;
        }

        .btn-add:hover {
            background: #45a049;
        }

        label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        h2 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .tabulator {
            margin-top: 10px;
        }

        /* Alertas */
        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* --- RESPONSIVE (todo 100% en pantallas peque√±as) --- */
        @media(max-width:768px) {
            .form-row>div {
                width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <div class="card">
            <div class="card-title">üìã Salidas Inventario</div>
            <div id="alert" class="alert"></div>

            <form id="terceroForm">

                <!-- ========================================================= -->
                <!--   B L O Q U E   C L I E N T E   (P O R C E N T A J E S)   -->
                <!-- ========================================================= -->
                <div class="form-row">
                    <div class="w-40">
                        <label>Cliente</label>
                        <select id="cliente" class="autocomplete"></select>
                    </div>


                    <div class="w-8">
                        <label>Fecha</label>
                        <input type="date" id="fecha">
                    </div>

                    <div class="w-50">
                        <label>Observaciones</label>
                        <input type="text" id="obs">
                    </div>
                </div>
                <hr>


                <!-- =============================================== -->
                <!--   B L O Q U E   I T E M S   (P O R C E N T A J E S)   -->
                <!-- =============================================== -->
                <div class="form-row">
                    <div class="w-40">
                        <label>Item</label>
                        <select id="item" class="autocomplete"></select>
                    </div>

                    <div class="w-10">
                        <label>% IVA</label>
                        <input type="number" class="input-derecha" id="iva" step="0.01">
                    </div>

                    <div class="w-10">
                        <label>Precio Salida</label>
                        <input type="number" class="input-derecha" id="psalida" step="0.01">
                    </div>

                    <div class="w-10">
                        <label>% Desc</label>
                        <input type="number" class="input-derecha" id="descuento" value="0">
                    </div>

                    <div class="w-10">
                        <label>Cantidad</label>
                        <input type="number" class="input-derecha" id="cantidad" value="1">
                    </div>

                    <div class="w-10">
                        <label>&nbsp;</label>
                        <button type="button" class="btn-add" onclick="agregarItem()">‚ûï Agregar </button>
                    </div>
                </div>

                <!-- TABULATOR -->
                <div id="tablaItems"></div>
                <style>
                    /* respaldo por CSS para asegurar m√≠nimo aunque Tabulator falle */
                    #tablaItems {
                        min-height: 200px;
                    }
                </style>
                <hr>

                <!-- ====================================================== -->
                <!--   B L O Q U E   T O T A L E S   (P O R C E N T A J E S)   -->
                <!-- ====================================================== -->
                <div class="form-row">
                    <div class="w-40">
                        <label>&nbsp;</label>
                    </div>
                    <div class="w-12">
                        <label>Subtotal</label>
                        <input id="subtotal" class="input-derecha" readonly>
                    </div>

                    <div class="w-11">
                        <label>Descuento</label>
                        <input id="t_desc" class="input-derecha" readonly>
                    </div>

                    <div class="w-11">
                        <label>IVA</label>
                        <input id="t_iva" class="input-derecha" readonly>
                    </div>

                    <div class="w-12">
                        <label>Total</label>
                        <input id="total" class="input-derecha" readonly>
                    </div>

                    <div class="w-10">
                        <label>&nbsp;</label>
                        <button id="btn-guardar" type="button" onclick="guardarSalida()">üíæ Guardar</button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- ====================================================== -->
    <!--   J A V A S C R I P T   I N T A C T O   (NO MODIFICADO) -->
    <!-- ====================================================== -->
    <script>
        const API_URL = '../blank_backend_salidas/blank_backend_salidas.php';

        let tabla = new Tabulator("#tablaItems", {
            layout: "fitColumns",
            minHeight: 300,
            placeholder: "No hay √≠tems agregados",
            columns: [
                { title: "C√≥digo", field: "codigo", width: 80 },
                { title: "Descripci√≥n", field: "nombre", widthGrow: 2 },
                { title: "Precio", field: "psalida", hozAlign: "right", formatter: "money", formatterParams: { precision: 2 } },
                { title: "IVA%", field: "por_iva", hozAlign: "right" },
                { title: "Desc%", field: "descuento", hozAlign: "right" },
                { title: "Cantidad", field: "cantidad", hozAlign: "right" },
                { title: "Subtotal", field: "subtotal", hozAlign: "right", formatter: "money", formatterParams: { precision: 2 } },
                {
                    title: "",
                    formatter: "buttonCross",
                    width: 50,
                    align: "center",
                    cellClick: (e, cell) => {
                        const row = cell.getRow();
                        // row.delete() devuelve una promesa en Tabulator, usamos then para ajustar
                        row.delete().then(() => {
                            calcularTotales();
                            ajustarAlturaSegunFilas();
                        }).catch(err => {
                            console.error('Error al eliminar fila:', err);
                            // aun as√≠ intentamos ajustar
                            calcularTotales();
                            ajustarAlturaSegunFilas();
                        });
                    }
                }

            ]
        });

        // funci√≥n para alternar altura seg√∫n tenga filas o no
        // funci√≥n segura para alternar altura
        function ajustarAlturaSegunFilas() {
            // NO modificar alturas desde JS
            try {
                tabla.redraw(true);
            } catch { }
        }
        ajustarAlturaSegunFilas();
        //tabla.on("dataChanged", function(data){ ajustarAlturaSegunFilas(); });

        // funci√≥n segura para alternar altura
        function ajustarAlturaSegunFilas() {
            // proteger si tabla no est√° inicializada a√∫n
            if (typeof tabla === 'undefined' || tabla === null) return;

            // obtener filas (getData siempre devuelve array)
            let filas = [];
            try {
                filas = tabla.getData() || [];
            } catch (e) {
                filas = [];
            }

            if (!filas || filas.length === 0) {
                // fijar altura m√≠nima cuando est√° vac√≠o
                try {
                    tabla.setHeight(200); // px
                } catch (e) {
                    // fallback: establecer altura por CSS del contenedor
                    document.querySelector('#tablaItems').style.minHeight = '200px';
                }
            } else {
                // quitar la altura fija de forma segura
                try {
                    tabla.setHeight(""); // limpia la altura fija
                    // redraw diferido para evitar mediciones sobre elementos no listos
                    setTimeout(() => {
                        try {
                            tabla.redraw(true);
                        } catch (e) {
                            // si falla redraw, no rompemos la app
                            console.warn('redraw fallo:', e);
                        }
                    }, 0);
                } catch (e) {
                    // √∫ltimo recurso: intentar quitar el estilo minHeight del contenedor
                    const el = document.querySelector('#tablaItems');
                    if (el) el.style.minHeight = '';
                }
            }
        }

        function cargarClientes() {

            $.ajax({
                url: API_URL,
                method: 'GET',
                data: { action: 'clientes' },
                success: function (response) {


                    // Parsear si viene como string
                    let data = response;
                    if (typeof response === 'string') {
                        try {
                            data = JSON.parse(response);
                        } catch (e) {
                            console.error('Error al parsear JSON:', e);
                            mostrarAlerta('Error al cargar clientes', 'error');
                            return;
                        }
                    }

                    let sel = $('#cliente');
                    sel.html('<option value="">Seleccione...</option>');

                    if (Array.isArray(data)) {
                        data.forEach(p => {
                            sel.append(`<option value="${p.codigo}">${p.identificacion} - ${p.nombre}</option>`);
                        });
                        //console.log('‚úì Proveedores cargados:', data.length);
                    } else {
                        //console.error('Formato de datos incorrecto:', data);
                        mostrarAlerta('Error al cargar clientes', 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar clientes:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    mostrarAlerta('‚ö†Ô∏è Error al cargar clientes', 'error');
                }
            });
        }




        function cargarItems() {
            $.ajax({
                url: API_URL,
                method: 'GET',
                data: { action: 'items' },
                success: function (response) {
                    let data = typeof response === 'string' ? JSON.parse(response) : response;
                    let sel = $('#item');
                    sel.html('<option value="">Seleccione...</option>');
                    data.forEach(i => {
                        sel.append(`<option value="${i.codigo}" data-precio="${i.precio_sin_iva}" data-iva="${i.por_iva}">${i.codigo} - ${i.nombre}</option>`);
                    });
                }
            });
        }

        function agregarItem() {
            const sel = document.getElementById('item');

            if (!sel.value) return mostrarAlerta('Seleccione un item', 'error');
            const opt = sel.options[sel.selectedIndex];
            const codigo = sel.value;
            const nombre = sel.options[sel.selectedIndex].text;
            const psalida = parseFloat($('#psalida').val() || sel.options[sel.selectedIndex].dataset.precio);
            const por_iva = parseFloat($('#iva').val() || sel.options[sel.selectedIndex].dataset.iva);
            const descuento = parseFloat($('#descuento').val());
            const cantidad = parseFloat($('#cantidad').val());
            const subtotal = (psalida * (1 - descuento / 100)) * cantidad;

            tabla.addRow({ codigo, nombre, psalida, por_iva, descuento, cantidad, subtotal });
            calcularTotales();
            setTimeout(ajustarAlturaSegunFilas, 0);

            $('#item').val('');
            $('#psalida').val('');
            $('#iva').val('');
            $('#descuento').val(0);
            $('#cantidad').val(1);
        }

        function calcularTotales() {
            const data = tabla.getData();
            let sub = 0, desc = 0, iva = 0;
            data.forEach(r => {
                sub += parseFloat(r.subtotal || 0);
                desc += (r.psalida * r.cantidad * (r.descuento / 100));
                iva += (r.subtotal * (r.por_iva / 100));
            });
            $('#subtotal').val(sub.toFixed(2));
            $('#t_desc').val(desc.toFixed(2));
            $('#t_iva').val(iva.toFixed(2));
            $('#total').val((sub + iva).toFixed(2));
        }

        function guardarSalida() {
            const salidaData = {
                cliente: $('#cliente').val(),
                plazo: $('#plazo').val(),
                fecha: $('#fecha').val(),
                subtotal: $('#subtotal').val(),
                descuento: $('#t_desc').val(),
                iva: $('#t_iva').val(),
                total: $('#total').val(),
                obs: $('#obs').val(),
                items: tabla.getData()
            };

            if (!salidaData.cliente) return mostrarAlerta('Seleccione un cliente', 'error');
            if (!salidaData.fecha) return mostrarAlerta('Seleccione una fecha', 'error');
            if (!salidaData.obs) return mostrarAlerta('Digite una Observacion', 'error');
            if (salidaData.items.length === 0) return mostrarAlerta('Debe agregar al menos un item', 'error');

            $('#btn-guardar').prop('disabled', true).text('Guardando...');

            $.post(API_URL, { action: 'guardar', data: JSON.stringify(salidaData) }, function (response) {
                let resp = typeof response === 'string' ? JSON.parse(response) : response;

                $('#btn-guardar').prop('disabled', false).text('üíæ Guardar');

                if (resp.ok) {
                    mostrarAlerta('Salida guardada correctamente', 'success');
                    setTimeout(() => location.reload(), 1200);
                } else {
                    mostrarAlerta('Error: ' + resp.mensaje, 'error');
                }
            });
        }

        function mostrarAlerta(msg, tipo) {
            const alert = $('#alert');
            alert.removeClass('alert-success alert-error');
            alert.addClass('alert-' + (tipo === 'success' ? 'success' : 'error'));
            alert.text(msg).fadeIn();
            setTimeout(() => alert.fadeOut(), tipo === 'success' ? 2000 : 4000);
        }

        $('#item').on('change', function () {
            const sel = this.options[this.selectedIndex];
            $('#psalida').val(sel.dataset.precio || '');
            $('#iva').val(sel.dataset.iva || '');
        });

        $(document).ready(function () {
            $('#fecha').val(new Date().toISOString().split('T')[0]);
            cargarClientes();
            cargarItems();

            $("#cliente").select2({ placeholder: "Buscar cliente...", allowClear: true, width: "100%" });
            $("#item").select2({ placeholder: "Buscar item...", allowClear: true, width: "100%" });
        });
    </script>
</body>

</html>
<?php