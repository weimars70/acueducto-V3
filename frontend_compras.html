?>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Compras</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.0/css/tabulator.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/5.5.0/js/tabulator.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .grid {
            display: grid;
            gap: 10px;
        }

        .grid-5 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        /* --- FORM GRID PRINCIPAL --- */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        .footer-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr) auto;
            gap: 10px;
            align-items: end;
            margin-top: 15px;
        }

        /* Porcentajes Bloque CLIENTE */
        .w-40 {
            width: 40%;
        }

        .w-50 {
            width: 50%;
        }

        .w-60 {
            width: 60%;
        }

        .w-15 {
            width: 15%;
        }

        .w-8 {
            width: 8%;
        }

        /* Porcentajes Bloque ITEMS */
        .w-5 {
            width: 5%;
        }

        .w-10 {
            width: 10%;
        }

        .w-11 {
            width: 11%;
        }

        .w-12 {
            width: 12%;
        }

        .w-13 {
            width: 13%;
        }

        .w-20 {
            width: 20%;
        }

        .w-23 {
            width: 23%;
        }

        /* Porcentajes Bloque TOTALES */
        .w-20 {
            width: 20%;
        }


        input,
        select,
        button {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background: #2196f3;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background: #1976d2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-add {
            background: #4CAF50;
        }

        .btn-add:hover {
            background: #45a049;
        }

        label {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        h2 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .tabulator {
            margin-top: 10px;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .input-derecha {
            text-align: right;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>üìã Registro de Compras</h2>

        <div id="alert" class="alert"></div>

        <!-- Datos principales -->
        <div class="form-row">

            <div class="w-50">
                <label>Proveedor</label>
                <select id="proveedor" class="autocomplete"></select>
            </div>
            <div class="w-10"><label>Factura</label><input id="factura"></div>
            <div class="w-10"><label>Forma de Pago</label>
                <select id="forma_pago">
                    <option value="1">Efectivo</option>
                    <option value="2">Transferencia</option>
                    <option value="3">Cr√©dito</option>
                </select>
            </div>
            <div class="w-10"><label>Plazo (d√≠as)</label><input type="number" id="plazo" value="0"></div>
            <div class="w-10"><label>Fecha</label><input type="date" id="fecha"></div>
        </div>

        <hr>

        <!-- L√≠nea de items -->
        <div class="form-row">
            <div class="w-50">
                <label>Item</label>
                <select id="item" class="autocomplete"></select>
            </div>
            <div class="w-5"><label>% IVA</label><input type="number" class="input-derecha" id="iva" step="0.01"></div>
            <div class="w-10"><label>Precio Compra</label><input type="number" id="pcompra" class="input-derecha"
                    step="0.01"></div>
            <div class="w-5"><label>% Desc</label><input type="number" id="descuento" class="input-derecha" step="0.01"
                    value="0"></div>
            <div class="w-5"><label>Cantidad</label><input type="number" id="cantidad" class="input-derecha" step="1"
                    value="1"></div>
            <div class="w-10">
                <label>&nbsp;</label>
                <button type="button" class="btn-add" onclick="agregarItem()">‚ûï Agregar </button>
            </div>
        </div>

        <div id="tablaItems"></div>

        <!-- Totales -->
        <div class="footer-row">
            <div><label>Subtotal</label><input id="subtotal" class="input-derecha" readonly value="0.00"></div>
            <div><label>Descuento</label><input id="t_desc" class="input-derecha" readonly value="0.00"></div>
            <div><label>IVA</label><input id="t_iva" class="input-derecha" readonly value="0.00"></div>
            <div><label>Total</label><input id="total" class="input-derecha" readonly value="0.00"></div>
            <div><button id="btn-guardar" onclick="guardarCompra()">üíæ Guardar Compra</button></div>
        </div>
    </div>

    <script>
        // URL del archivo PHP que conecta con la base de datos
        const API_URL = '../blank_backend_compras/blank_backend_compras.php';

        let tabla = new Tabulator("#tablaItems", {
            layout: "fitColumns",
            responsiveLayout: "collapse",
            placeholder: "No hay √≠tems agregados",
            columns: [
                { title: "C√≥digo", field: "codigo", width: 80 },
                { title: "Descripci√≥n", field: "nombre", widthGrow: 2 },
                { title: "Precio", field: "pcompra", hozAlign: "right", formatter: "money", formatterParams: { precision: 2 } },
                { title: "IVA%", field: "por_iva", hozAlign: "right" },
                { title: "Desc%", field: "descuento", hozAlign: "right" },
                { title: "Cantidad", field: "cantidad", hozAlign: "right" },
                { title: "Subtotal", field: "subtotal", hozAlign: "right", formatter: "money", formatterParams: { precision: 2 } },
                {
                    title: "",
                    formatter: "buttonCross",
                    width: 50,
                    align: "center",
                    cellClick: (e, cell) => {
                        const row = cell.getRow();
                        // row.delete() devuelve una promesa en Tabulator, usamos then para ajustar
                        row.delete().then(() => {
                            calcularTotales();
                            ajustarAlturaSegunFilas();
                        }).catch(err => {
                            console.error('Error al eliminar fila:', err);
                            // aun as√≠ intentamos ajustar
                            calcularTotales();
                            ajustarAlturaSegunFilas();
                        });
                    }
                }

            ]
        });


        function ajustarAlturaSegunFilas() {
            // NO modificar alturas desde JS
            try {
                tabla.redraw(true);
            } catch { }
        }
        ajustarAlturaSegunFilas();

        function ajustarAlturaSegunFilas() {
            // proteger si tabla no est√° inicializada a√∫n
            if (typeof tabla === 'undefined' || tabla === null) return;

            // obtener filas (getData siempre devuelve array)
            let filas = [];
            try {
                filas = tabla.getData() || [];
            } catch (e) {
                filas = [];
            }

            if (!filas || filas.length === 0) {
                // fijar altura m√≠nima cuando est√° vac√≠o
                try {
                    tabla.setHeight(200); // px
                } catch (e) {
                    // fallback: establecer altura por CSS del contenedor
                    document.querySelector('#tablaItems').style.minHeight = '200px';
                }
            } else {
                // quitar la altura fija de forma segura
                try {
                    tabla.setHeight(""); // limpia la altura fija
                    // redraw diferido para evitar mediciones sobre elementos no listos
                    setTimeout(() => {
                        try {
                            tabla.redraw(true);
                        } catch (e) {
                            // si falla redraw, no rompemos la app
                            console.warn('redraw fallo:', e);
                        }
                    }, 0);
                } catch (e) {
                    // √∫ltimo recurso: intentar quitar el estilo minHeight del contenedor
                    const el = document.querySelector('#tablaItems');
                    if (el) el.style.minHeight = '';
                }
            }
        }

        // -----------------------------
        // Cargar proveedores
        // -----------------------------


        function cargarProveedores() {
            console.log('Cargar  proveedores:');
            $.ajax({
                url: API_URL,
                method: 'GET',
                data: { action: 'proveedores' },
                success: function (response) {
                    console.log('Respuesta proveedores:', response);

                    // Parsear si viene como string
                    let data = response;
                    if (typeof response === 'string') {
                        try {
                            data = JSON.parse(response);
                        } catch (e) {
                            console.error('Error al parsear JSON:', e);
                            mostrarAlerta('Error al cargar Proveedores', 'error');
                            return;
                        }
                    }

                    let sel = $('#proveedor');
                    sel.html('<option value="">Seleccione...</option>');

                    if (Array.isArray(data)) {
                        data.forEach(p => {
                            sel.append(`<option value="${p.codigo}">${p.identificacion} - ${p.nombre}</option>`);
                        });
                        //console.log('‚úì Proveedores cargados:', data.length);
                    } else {
                        //console.error('Formato de datos incorrecto:', data);
                        mostrarAlerta('Error al cargar proveedores', 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar proveedor:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    mostrarAlerta('‚ö†Ô∏è Error al cargar proveedor', 'error');
                }
            });
        }

        // -----------------------------
        // Cargar items
        // -----------------------------
        function cargarItems() {
            $.ajax({
                url: API_URL,
                method: 'GET',
                data: { action: 'items' },
                success: function (response) {
                    console.log('Respuesta items:', response);

                    // Parsear si viene como string
                    let data = response;
                    if (typeof response === 'string') {
                        try {
                            data = JSON.parse(response);
                        } catch (e) {
                            console.error('Error al parsear JSON:', e);
                            mostrarAlerta('Error al cargar items', 'error');
                            return;
                        }
                    }

                    let sel = $('#item');
                    sel.html('<option value="">Seleccione...</option>');

                    if (Array.isArray(data)) {
                        data.forEach(i => {
                            sel.append(`<option value="${i.codigo}" data-precio="${i.precio_sin_iva}" data-iva="${i.por_iva}">${i.codigo} - ${i.nombre}</option>`);
                        });
                        console.log('‚úì Items cargados:', data.length);
                    } else {
                        console.error('Formato de datos incorrecto:', data);
                        mostrarAlerta('Error al cargar items', 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar √≠tems:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    mostrarAlerta('‚ö†Ô∏è Error al cargar items', 'error');
                }
            });
        }

        // -----------------------------
        // Agregar item a la tabla
        // -----------------------------
        function agregarItem() {
            const sel = document.getElementById('item');
            if (!sel.value) {
                mostrarAlerta('Seleccione un item', 'error');
                return;
            }

            const codigo = sel.value;
            const nombre = sel.options[sel.selectedIndex].text;
            const pcompra = parseFloat($('#pcompra').val() || sel.options[sel.selectedIndex].dataset.precio || 0);
            const por_iva = parseFloat($('#iva').val() || sel.options[sel.selectedIndex].dataset.iva || 0);
            const descuento = parseFloat($('#descuento').val() || 0);
            const cantidad = parseFloat($('#cantidad').val() || 1);

            if (cantidad <= 0) {
                mostrarAlerta('La cantidad debe ser mayor a 0', 'error');
                return;
            }

            if (pcompra <= 0) {
                mostrarAlerta('El precio debe ser mayor a 0', 'error');
                return;
            }

            const subtotal = (pcompra * (1 - descuento / 100)) * cantidad;

            tabla.addRow({ codigo, nombre, pcompra, por_iva, descuento, cantidad, subtotal });
            calcularTotales();
            setTimeout(ajustarAlturaSegunFilas, 0);

            // Limpiar campos
            $('#item').val('');
            $('#pcompra').val('');
            $('#iva').val('');
            $('#descuento').val(0);
            $('#cantidad').val(1);

            mostrarAlerta('Item agregado', 'success');
        }

        // -----------------------------
        // Calcular totales
        // -----------------------------
        function calcularTotales() {
            const data = tabla.getData();
            let sub = 0, desc = 0, iva = 0;
            data.forEach(r => {
                sub += parseFloat(r.subtotal || 0);
                desc += (r.pcompra * r.cantidad * (r.descuento / 100));
                iva += (r.subtotal * (r.por_iva / 100));
            });
            $('#subtotal').val(sub.toFixed(2));
            $('#t_desc').val(desc.toFixed(2));
            $('#t_iva').val(iva.toFixed(2));
            $('#total').val((sub + iva).toFixed(2));
        }

        // -----------------------------
        // Guardar compra
        // -----------------------------
        function guardarCompra() {
            const compraData = {
                proveedor: $('#proveedor').val(),
                factura: $('#factura').val(),
                forma_pago: $('#forma_pago').val(),
                plazo: $('#plazo').val(),
                fecha: $('#fecha').val(),
                subtotal: $('#subtotal').val(),
                descuento: $('#t_desc').val(),
                iva: $('#t_iva').val(),
                total: $('#total').val(),
                items: tabla.getData()
            };


            if (!compraData.proveedor) {
                mostrarAlerta('Seleccione un proveedor', 'error');
                return;
            }
            if (!compraData.factura) {
                mostrarAlerta('Ingrese n√∫mero de factura', 'error');
                return;
            }
            if (!compraData.fecha) {
                mostrarAlerta('Seleccione una fecha', 'error');
                return;
            }
            if (compraData.items.length === 0) {
                mostrarAlerta('Debe agregar al menos un item', 'error');
                return;
            }

            // Deshabilitar bot√≥n
            $('#btn-guardar').prop('disabled', true).text('Guardando...');
            console.log('compraData:::', JSON.stringify(compraData));
            //return;
            $.ajax({
                url: API_URL,
                method: 'POST',
                data: {
                    action: 'guardar',
                    data: JSON.stringify(compraData)
                },
                success: function (response) {
                    $('#btn-guardar').prop('disabled', false).text('üíæ Guardar Compra');

                    console.log('Respuesta guardar:', response);

                    // Parsear si viene como string
                    let resp = response;
                    if (typeof response === 'string') {
                        try {
                            resp = JSON.parse(response);
                        } catch (e) {
                            console.error('Error al parsear respuesta:', e);
                            mostrarAlerta('Error al procesar la respuesta', 'error');
                            return;
                        }
                    }

                    if (resp.ok) {
                        mostrarAlerta(resp.mensaje || 'Compra guardada correctamente', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        mostrarAlerta('Error: ' + (resp.mensaje || 'No se pudo guardar'), 'error');
                        console.error('Error del servidor:', resp);
                    }
                },
                error: function (xhr, status, error) {
                    $('#btn-guardar').prop('disabled', false).text('üíæ Guardar Compra');
                    console.error('Error guardando compra:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    mostrarAlerta('‚ö†Ô∏è Error al guardar: ' + error, 'error');
                }
            });
        }

        // Mostrar alertas
        function mostrarAlerta(mensaje, tipo) {
            const alert = $('#alert');
            alert.removeClass('alert-success alert-error');
            alert.addClass('alert-' + tipo);
            alert.text(mensaje);
            alert.fadeIn();
            setTimeout(() => { alert.fadeOut(); }, tipo === 'success' ? 2000 : 4000);
        }

        // Auto-completar campos al seleccionar item
        $('#item').on('change', function () {
            const sel = this.options[this.selectedIndex];
            if (sel.value) {
                $('#pcompra').val(sel.dataset.precio || '');
                $('#iva').val(sel.dataset.iva || '');
            }
        });
        $(document).ready(function () {
            $('#fecha').val(new Date().toISOString().split('T')[0]);
            cargarProveedores();
            cargarItems();

            $("#proveedor").select2({ placeholder: "Buscar proveedor...", allowClear: true, width: "100%" });
            $("#item").select2({ placeholder: "Buscar item...", allowClear: true, width: "100%" });
        });


        // Establecer fecha actual por defecto
        /*$(document).ready(function(){
          const hoy = new Date().toISOString().split('T')[0];
          $('#fecha').val(hoy);
          
          $("#proveedor").select2({ placeholder:"Buscar Proveedors...", allowClear:true, width:"100%" });
          $("#item").select2({ placeholder:"Buscar Items...", allowClear:true, width:"100%" });
          cargarProveedores();
          cargarItems();
        });*/
    </script>
</body>

</html>
<?php